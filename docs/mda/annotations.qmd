---
title: Annotations
description: "Examples of using Annotations"
jupyter: python3
execute:
  daemon: false
---

Annotations can be added to trajectories using the [Annotations API](../api/annotations.html). Molecular Nodes comes with a few bundled annotations for trajectories, but new ones can be dynamically added as well.

## Setup Molecular Nodes

```{python}
import molecularnodes as mn
import MDAnalysis as mda
from MDAnalysis.tests.datafiles import DCD, PSF, TPR, XTC

# create a canvas object
canvas = mn.Canvas()
```

## Add Trajectory

```{python}
#| warning: false
u = mda.Universe(PSF, DCD)
t = mn.Trajectory(u).add_style("cartoon")
```

## Annotations

The bundled annotation types for Trajectories are:

- [`atom_info`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.AtomInfo) - For atom info
- [`com`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.COM) - For center-of-mass of a selection
- [`com_distance`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.COMDistance) - For distance between two center-of-masses
- [`canonical_dihedrals`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.CanonicalDihedrals) - For canonical dihedrals of a residue
- [`universe_info`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.UniverseInfo) - For universe info
- [`label_2d`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.Label2D) - For adding a generic 2d label in viewport / render
- [`label_3d`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.Label3D) - For adding a generic 3d label

All selections used in the annotation APIs can be either MDAnalysis selection phrases (strings) or instances of `AtomGroup`s.

Annotations can be added using the `add_<annotation_type>` method, which returns an instance that can be used to further customize the annotation. Annotation specific inputs as well as common annotation parameters can be customized. For more details about the common annotation parameters, see the Annotations API section.

### [atom_info](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.AtomInfo)

Display the atom info of a selection.

The input parameters for this annotation are:

- `selection` - An MDAnalysis selection phrase or `AtomGroup`
- `show_resid` - Whether to show the resid
- `show_segid` - Whether to show the segid

```{python}
# add a style to display all the alpha carbons as spheres
t.add_style(
    selection="name CA", style="ball_and_stick", color=(0.162, 0.624, 0.196, 1.0)
)
# add the atom_info annotation
a1 = t.annotations.add_atom_info(
    selection="resid 73:78 and name CA",
    show_resid=True,
    show_segid=True,
)
# set the font size to 12
a1.text_size = 12
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view("resid 73:78"), viewpoint="front")
canvas.snapshot()
```

```{python}
# hide the annotation and remove the added style
a1.visible = False
t.styles[1].remove()
```

### [com](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.COM)

Display the center-of-mass of a selection.

The input parameters for this annotation are:

- `selection` - An MDAnalysis selection phrase or `AtomGroup`
- `text` - Text to be displayed at the center-of-mass of selection

```{python}
# show com of the whole protein
a2 = t.annotations.add_com(selection="protein", text="Protein|COM")
# show com of residues 150 through 170
a3 = t.annotations.add_com(selection="resid 150:170", text="resid 150:170|COM")
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view(), viewpoint="front")
canvas.snapshot()
```

```{python}
# hide the added annotations
a2.visible = False
a3.visible = False
```

### [com_distance](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.COMDistance)

Display the distance between center-of-masses of two selections.

The input parameters for this annotation are:

- `selection1` - An MDAnalysis selection phrase or `AtomGroup` of first selection
- `selection2` - An MDAnalysis selection phrase or `AtomGroup` of second selection
- `text1` - Text to display at com of first selection
- `text2` - Text to display at com of second selection

```{python}
# add com_distance between resid 1 and 129
a4 = t.annotations.add_com_distance(
    selection1="resid 1",
    selection2=u.select_atoms("resid 129"),
    text1="resid 1|COM",
    text2="resid 129|COM",
)
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view("resid 1 129"), viewpoint="bottom")
canvas.snapshot()
```

```{python}
# hide the added annotation
a4.visible = False
```

### [canonical_dihedrals](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.CanonicalDihedrals)

Display the canonical dihedrals of a residue

The input parameters for this annotation are:

- `resid` - The residue id
- `show_atom_names` - Whether to show the atom names in the residue
- `show_direction` - Whether to show the direction arcs of the dihedral angles

```{python}
# show canonical dihedrals of residue 200
a5 = t.annotations.add_canonical_dihedrals(resid=200)
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view("resid 200"), viewpoint="back")
canvas.snapshot()
```

```{python}
# hide the added annotation
a5.visible = False
```

### [universe_info](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.UniverseInfo)

Display the universe info of the trajectory.

The input parameters for this annotation are:

- `location` - Normalized 2d location (0.0 - 1.0) to show the info wrt viewport / render
- `show_frame` - Whether or not to show the frame number of the trajectory
- `show_topology` - Whether or not to show the topology filename
- `show_trajectory` - Whether or not to show the trajectory filename
- `show_atoms` - Whether or not to show the number of atoms in the universe

```{python}
# add universe_info annotation
a6 = t.annotations.add_universe_info()
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view(), viewpoint="top")
canvas.snapshot(frame=50)
```

```{python}
# hide the added annotation
a6.visible = False
```

### [label_2d](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.Label2D)

Display a generic 2d label in the viewport / render.

The input parameters for this annotation are:

- `text` - Text to display
- `location` - Normalized location (0.0 - 1.0) to show the text wrt viewport / render

```{python}
# show a 2d label at the top left
a7 = t.annotations.add_label_2d(text="Any|2D Label", location=(0.1, 0.8))
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view(), viewpoint="left")
canvas.snapshot()
```

```{python}
# hide the added annotation
a7.visible = False
```

### [label_3d](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.Label3D)

Display a generic 3d label on the universe.

The input parameters for this annotation are:

- `text` - Text to display
- `location` - 3d coordinates in universe to display text

```{python}
# show the alpha carbon of resid 1 as a sphere
t.add_style(
    selection="resid 1 and name CA",
    style="ball_and_stick",
    color=(0.162, 0.624, 0.196, 1.0),
)
# select the alpha carbon of resid 1
r1 = t.universe.select_atoms("resid 1 and name CA")
atom = r1.atoms[0]
# add a 3d label to display text at this atom's location
a8 = t.annotations.add_label_3d(text=f"CA|resid 1|{atom.segid}", location=atom.position)
# add a pointer to point at the location
a8.pointer_length = 2
a8.line_width = 2
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view("resid 1"), viewpoint="front")
canvas.snapshot()
```

```{python}
# hide the added annotation
a8.visible = False
# remove the added style
t.styles[1].remove()
```

## Custom Annotations

In addition to the above bundled annotations for Trajectories, custom annotation types can be created by extending the [`TrajectoryAnnotation`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.TrajectoryAnnotation) class. These custom annotation types will be automatically registered and can be added using the same `add_<annotation_type>` method of a trajectory instance. The GUI to add and configure the annotation will also be automatically available. For more details about custom annotations, see the Annotations API section.

### Add a custom annotation

A custom trajectory annotation class has to extend [`TrajectoryAnnotation`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.TrajectoryAnnotation) and implement the [`draw`](../api/reference/annotations.base.html#molecularnodes.annotations.base.BaseAnnotation.draw) method. Optional [`defaults`](../api/reference/annotations.base.html#molecularnodes.annotations.base.BaseAnnotation.defaults) method can be used to set defaults for the annotation and a [`validate`](../api/reference/annotations.base.html#molecularnodes.annotations.base.BaseAnnotation.validate) method that can validate inputs when they change can be implemented. The custom class will have access to the trajectory entity via `self.trajectory`, universe via `self.trajectory.universe` and the annotation params via `self.interface`. Please see the Annotations API for all the methods available to draw onto the viewport / renders from the [`draw`](../api/reference/annotations.base.html#molecularnodes.annotations.base.BaseAnnotation.draw) code.

```{python}
# Add a CutomAnnotation class
# This class will auto-register with the Trajectory entities
class CustomAnnotation(mn.entities.trajectory.TrajectoryAnnotation):
    annotation_type = "custom_annotation"

    selection: str  # required param
    bool_param: bool = False  # optional bool param

    # optional defaults method
    def defaults(self) -> None:
        # any default settings for this annotation go here
        params = self.interface
        # set text size to 24
        params.text_size = 20

    # optional validate method
    def validate(self) -> bool:
        # validate any input params that change (either through API or GUI)
        # return True if validation succeeds else False or raise an Exception
        params = self.interface
        universe = self.trajectory.universe
        # validate and save the selection atom group
        if isinstance(params.selection, str):
            # check if selection phrase is valid
            # mda throws exception if invalid
            self.atom_group = universe.select_atoms(params.selection)
        elif isinstance(params.selection, AtomGroup):
            self.atom_group = params.selection
        else:
            raise ValueError(f"Need str or AtomGroup. Got {type(params.selection)}")
        return True

    # required draw method
    def draw(self) -> None:
        # the draw code for this annotation
        # self.trajectory points to the trajectory instance
        # self.interface points to the interface that provides
        #     the annotation inputs and common annotation parameters
        # show the atom names of the selection
        for atom in self.atom_group:
            self.draw_text_3d(atom.position, atom.name)
```

```{python}
t.add_style(selection="resid 75", style="ball_and_stick")
# add the custom annotation and pass the required selection parameter
a9 = t.annotations.add_custom_annotation(selection="resid 75")
```

```{python}
# frame the view and render
canvas.frame_view(t.get_view("resid 75"), viewpoint="front")
canvas.snapshot()
```

```{python}
# hide the added annotation
a9.visible = False
```

### Unregister a custom annotation

Custom annotations get automatically registered with the [`TrajectoryAnnotationManager`](../api/reference/entities.trajectory.annotations.html#molecularnodes.entities.trajectory.annotations.TrajectoryAnnotationManager). They can be manually unregistered and re-registered using the [`unregister`](../api/reference/annotations.manager.html#molecularnodes.annotations.manager.BaseAnnotationManager.unregister) and [`register`](../api/reference/annotations.manager.html#molecularnodes.annotations.manager.BaseAnnotationManager.register) methods if required.

```{python}
# unregister the annotation
manager = mn.entities.trajectory.TrajectoryAnnotationManager
manager.unregister(CustomAnnotation)
```
